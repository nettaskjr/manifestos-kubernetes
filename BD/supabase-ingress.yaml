# --- DEFINIÇÃO DOS MIDDLEWARES (As "Tesouras" de URL) ---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-auth
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - /auth/v1
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-rest
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - /rest/v1
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-storage
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - /storage/v1
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-realtime
  namespace: default
spec:
  stripPrefix:
    prefixes:
      - /realtime/v1

---
# --- INGRESS 1: STUDIO (INTERFACE) ---
# Este é o padrão, pega a raiz "/"
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supabase-ingress-studio
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    # Usa APENAS o force-https
    traefik.ingress.kubernetes.io/router.middlewares: portainer-force-https@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: supabase.<<seu-dominio>> # <--- MUDE AQUI
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: supabase-studio-svc
                port: { number: 3000 }

---
# --- INGRESS 2: AUTH (GOTRUE) ---
# Redireciona /auth/v1/* para o container na raiz /
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supabase-ingress-auth
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    # Aplica HTTPS + Remove o prefixo /auth/v1
    traefik.ingress.kubernetes.io/router.middlewares: portainer-force-https@kubernetescrd, default-strip-auth@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: supabase.<<seu-dominio>> # <--- MUDE AQUI
      http:
        paths:
          - path: /auth/v1
            pathType: Prefix
            backend:
              service:
                name: supabase-auth
                port: { number: 80 }

---
# --- INGRESS 3: REST API (POSTGREST) ---
# Redireciona /rest/v1/* para o container na raiz /
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supabase-ingress-rest
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    # Aplica HTTPS + Remove o prefixo /rest/v1
    traefik.ingress.kubernetes.io/router.middlewares: portainer-force-https@kubernetescrd, default-strip-rest@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: supabase.<<seu-dominio>> # <--- MUDE AQUI
      http:
        paths:
          - path: /rest/v1
            pathType: Prefix
            backend:
              service:
                name: supabase-rest
                port: { number: 80 }

---
# --- INGRESS 4: STORAGE (S3) ---
# Redireciona /storage/v1/* para o container na raiz /
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supabase-ingress-storage
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.middlewares: portainer-force-https@kubernetescrd, default-strip-storage@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: supabase.<<seu-dominio>> # <--- MUDE AQUI
      http:
        paths:
          - path: /storage/v1
            pathType: Prefix
            backend:
              service:
                name: supabase-storage
                port: { number: 80 }

---
# --- INGRESS 5: REALTIME (WEBSOCKET) ---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: supabase-ingress-realtime
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.middlewares: portainer-force-https@kubernetescrd, default-strip-realtime@kubernetescrd
spec:
  ingressClassName: traefik
  rules:
    - host: supabase.<<seu-dominio>> # <--- MUDE AQUI
      http:
        paths:
          - path: /realtime/v1
            pathType: Prefix
            backend:
              service:
                name: supabase-realtime
                port: { number: 80 }
